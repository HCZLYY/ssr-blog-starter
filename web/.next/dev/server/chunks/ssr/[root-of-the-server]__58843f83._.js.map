{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 10, "column": 0}, "map": {"version":3,"sources":["file:///E:/%E5%AD%97%E8%8A%82-%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9A-2/Github/ssr-blog-starter/web/pages/admin/index.js"],"sourcesContent":["// web/pages/admin/index.js\r\nimport { useEffect, useState } from 'react';\r\n\r\nexport default function Admin() {\r\n    const [articles, setArticles] = useState([]);\r\n    const [loading, setLoading] = useState(false);\r\n    const [form, setForm] = useState({ id: null, title: '', summary: '', content: '', status: 'published' });\r\n    const [editing, setEditing] = useState(false);\r\n    const [err, setErr] = useState('');\r\n    const [msg, setMsg] = useState('');\r\n\r\n    const API_BASE = process.env.NEXT_PUBLIC_API_BASE || 'http://localhost:3000';\r\n\r\n    useEffect(() => { fetchList(); }, []);\r\n\r\n    async function fetchList() {\r\n        setLoading(true);\r\n        setErr('');\r\n        try {\r\n            const res = await fetch(`${API_BASE}/api/v1/articles?page=1&limit=50`);\r\n            const j = await res.json();\r\n            setArticles(j.value || []);\r\n        } catch (e) {\r\n            console.error('fetch list err', e);\r\n            setErr('无法获取文章列表');\r\n        } finally { setLoading(false); }\r\n    }\r\n\r\n    function handleChange(e) {\r\n        const { name, value } = e.target;\r\n        setForm(s => ({ ...s, [name]: value }));\r\n    }\r\n\r\n    function startEdit(a) {\r\n        setForm({ id: a.id, title: a.title || '', summary: a.summary || '', content: a.content || '', status: a.status || 'published' });\r\n        setEditing(true);\r\n    }\r\n\r\n    function resetForm() {\r\n        setForm({ id: null, title: '', summary: '', content: '', status: 'published' });\r\n        setEditing(false);\r\n    }\r\n\r\n    async function submitForm(e) {\r\n        e.preventDefault();\r\n        setErr(''); setMsg('');\r\n        try {\r\n            const payload = { title: form.title, summary: form.summary, content: form.content, status: form.status, tags: [] };\r\n            let res;\r\n            if (form.id) {\r\n                res = await fetch(`${API_BASE}/api/v1/articles/${form.id}`, {\r\n                    method: 'PUT',\r\n                    headers: { 'Content-Type': 'application/json; charset=utf-8' },\r\n                    body: JSON.stringify(payload)\r\n                });\r\n            } else {\r\n                res = await fetch(`${API_BASE}/api/v1/articles`, {\r\n                    method: 'POST',\r\n                    headers: { 'Content-Type': 'application/json; charset=utf-8' },\r\n                    body: JSON.stringify(payload)\r\n                });\r\n            }\r\n            if (!res.ok) throw new Error('服务器错误');\r\n            await fetchList();\r\n            resetForm();\r\n            setMsg('操作成功');\r\n        } catch (e) {\r\n            console.error(e);\r\n            setErr('提交失败');\r\n        }\r\n    }\r\n\r\n    async function handleDelete(id, physical = false) {\r\n        if (!confirm('确定删除这篇文章？')) return;\r\n        try {\r\n            const url = `${API_BASE}/api/v1/articles/${id}${physical ? '?physical=1' : ''}`;\r\n            const res = await fetch(url, { method: 'DELETE' });\r\n            if (!res.ok) throw new Error('删除失败');\r\n            await fetchList();\r\n            setMsg('删除成功');\r\n        } catch (e) {\r\n            console.error(e);\r\n            setErr('删除失败');\r\n        }\r\n    }\r\n\r\n    // -------- Admin token helpers --------\r\n    // 1) 请求 token 并保存到 localStorage（开发用）\r\n    async function getAndSaveAdminToken() {\r\n        setErr(''); setMsg('');\r\n        try {\r\n            const res = await fetch(`${API_BASE}/api/v1/admin/token`, {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json; charset=utf-8' },\r\n                body: JSON.stringify({ username: 'admin' }) // dev-only; change for prod\r\n            });\r\n            if (!res.ok) throw new Error('无法获取 token');\r\n            const j = await res.json();\r\n            if (j.token) {\r\n                localStorage.setItem('admin_token', j.token);\r\n                setMsg('token 已保存到 localStorage.admin_token');\r\n            } else {\r\n                throw new Error('响应未包含 token');\r\n            }\r\n        } catch (e) {\r\n            console.error(e);\r\n            setErr('获取 token 失败：' + e.message);\r\n        }\r\n    }\r\n\r\n    // 2) 从 localStorage 取 token\r\n    function getSavedToken() {\r\n        return localStorage.getItem('admin_token') || '';\r\n    }\r\n\r\n    // -------- Cache control --------\r\n    // 调用后端受保护的 cache refresh endpoint (统一使用 /cache/refresh)\r\n    async function refreshCacheAll(warm = false) {\r\n        setMsg(''); setErr('');\r\n        try {\r\n            const token = getSavedToken();\r\n            if (!token) return setErr('请先获取并保存 admin token（点击 \"获取并保存 token\"）');\r\n            const r = await fetch(`${API_BASE}/api/v1/admin/cache/refresh`, {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json; charset=utf-8', Authorization: `Bearer ${token}` },\r\n                body: JSON.stringify({ warm })\r\n            });\r\n            if (!r.ok) {\r\n                const j = await r.json().catch(() => ({}));\r\n                throw new Error(j.error || '刷新失败');\r\n            }\r\n            const j = await r.json();\r\n            setMsg('已刷新缓存: ' + JSON.stringify(j));\r\n            // 刷新本地列表视图\r\n            await fetchList();\r\n        } catch (e) {\r\n            console.error(e);\r\n            setErr('刷新失败：' + e.message);\r\n        }\r\n    }\r\n\r\n    return (\r\n        <div style={{ padding: 24, fontFamily: 'system-ui,Arial' }}>\r\n            <h1>Admin — 文章管理</h1>\r\n\r\n            <div style={{ marginBottom: 12 }}>\r\n                <button onClick={() => getAndSaveAdminToken()}>获取并保存 admin token（开发用）</button>\r\n                <button onClick={() => refreshCacheAll(false)} style={{ marginLeft: 8 }}>强制刷新缓存（清除）</button>\r\n                <button onClick={() => refreshCacheAll(true)} style={{ marginLeft: 8 }}>清除并预热</button>\r\n                <span style={{ marginLeft: 12, color: '#666' }}>（token 存在于 localStorage.admin_token）</span>\r\n            </div>\r\n            {msg && <div style={{ color: 'green', marginBottom: 12 }}>{msg}</div>}\r\n            {err && <div style={{ color: 'red', marginBottom: 12 }}>{err}</div>}\r\n\r\n            <section style={{ marginBottom: 20 }}>\r\n                <h2>{editing ? '编辑文章' : '新建文章'}</h2>\r\n                <form onSubmit={submitForm}>\r\n                    <div style={{ marginBottom: 8 }}>\r\n                        <input name=\"title\" value={form.title} onChange={handleChange} placeholder=\"标题\" style={{ width: '60%' }} />\r\n                    </div>\r\n                    <div style={{ marginBottom: 8 }}>\r\n                        <input name=\"summary\" value={form.summary} onChange={handleChange} placeholder=\"摘要\" style={{ width: '80%' }} />\r\n                    </div>\r\n                    <div style={{ marginBottom: 8 }}>\r\n                        <textarea name=\"content\" value={form.content} onChange={handleChange} placeholder=\"正文（HTML）\" rows={8} style={{ width: '90%' }} />\r\n                    </div>\r\n                    <div style={{ marginBottom: 8 }}>\r\n                        <select name=\"status\" value={form.status} onChange={handleChange}>\r\n                            <option value=\"published\">published</option>\r\n                            <option value=\"draft\">draft</option>\r\n                        </select>\r\n                        <button type=\"button\" onClick={() => { /* optional AI hook */ }} style={{ marginLeft: 12 }}>AI 生成草稿</button>\r\n                    </div>\r\n                    <div>\r\n                        <button type=\"submit\">{editing ? '保存修改' : '发布文章'}</button>\r\n                        <button type=\"button\" onClick={resetForm} style={{ marginLeft: 10 }}>重置</button>\r\n                    </div>\r\n                </form>\r\n            </section>\r\n\r\n            <section>\r\n                <h2>文章列表（最多 50）</h2>\r\n                {loading ? <div>加载中…</div> : (\r\n                    <table border=\"1\" cellPadding=\"6\" style={{ borderCollapse: 'collapse' }}>\r\n                        <thead>\r\n                            <tr><th>ID</th><th>标题</th><th>摘要</th><th>操作</th></tr>\r\n                        </thead>\r\n                        <tbody>\r\n                            {articles.map(a => (\r\n                                <tr key={a.id}>\r\n                                    <td>{a.id}</td>\r\n                                    <td style={{ maxWidth: 300 }}>{a.title}</td>\r\n                                    <td style={{ maxWidth: 400 }}>{a.summary}</td>\r\n                                    <td>\r\n                                        <button onClick={() => startEdit(a)}>编辑</button>\r\n                                        <button onClick={() => handleDelete(a.id)} style={{ marginLeft: 8 }}>逻辑删除</button>\r\n                                        <button onClick={() => handleDelete(a.id, true)} style={{ marginLeft: 6 }}>物理删除</button>\r\n                                    </td>\r\n                                </tr>\r\n                            ))}\r\n                        </tbody>\r\n                    </table>\r\n                )}\r\n            </section>\r\n\r\n            <div style={{ marginTop: 12, color: '#666' }}>\r\n                <p>开发提示：</p>\r\n                <ol>\r\n                    <li>点击 “获取并保存 admin token（开发用）” 会请求 <code>/api/v1/admin/token</code> 并把 token 保存到 <code>localStorage.admin_token</code>。</li>\r\n                    <li>也可以在后端运行 token 请求（PowerShell 或 curl），然后在浏览器开发者工具 Console 粘贴：\r\n                        <pre>localStorage.setItem('admin_token', 'PASTE_TOKEN_HERE')</pre>\r\n                    </li>\r\n                </ol>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n"],"names":[],"mappings":"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"}}]
}